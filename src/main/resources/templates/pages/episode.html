<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<link rel='stylesheet' href='https://cdn.plyr.io/3.2.4/plyr.css'>
<script src='https://cdn.plyr.io/3.2.4/plyr.js'></script>

<link rel="stylesheet" th:href="'../plyr/style.css'">
<script th:src="'../plyr/index.js'"></script>

<script type="application/javascript">
    $(window).bind("load", function () {
        player.currentTime = [[${time}]]
    });
</script>

<div th:switch="${currentUser.videoPlayer}">
    <video th:case="'plyr'" controls crossorigin playsinline th:poster="${episode.season.serie.backgroundImg}"
           id="player">
        <source th:src="'/video/episode/' + ${episode.id}">
    </video>
    <video th:case="*" controls crossorigin playsinline th:poster="${episode.season.serie.backgroundImg}" width="100%">
        <source th:src="'/video/episode/' + ${episode.id}">
    </video>
</div>
<br>
<div class="card card-body">
    <h1>
        <a th:text="${episode.season.serie.title} + ' Season ' + ${episode.season.season} + ' Episode '
    + ${episode.episode}"></a>
        <a th:if="${nextEpisode} != null" th:href="'/episode/' + ${nextEpisode.id}"
           class="btn btn-primary float-right">Next Episode</a>
    </h1>
    <p>
        <a th:href="'/video/episode/' + ${episode.id}" target="_blank" class="btn btn-primary">Download</a>
    </p>
    <p th:text="'Quality: ' + ${episode.quality}"></p>
    <p>Genres:
        <span th:each="genre : ${episode.season.serie.genres}">
            <a th:text="${genre.name}" th:href="'/serie?genre=' + ${genre.name}" class="badge"
               style="color: white;"></a>
        </span>
    </p>
    <p>
        <img th:src="'http://www.barcodes4.me/barcode/qr/qr.png?value=http://scorewinner.ch:8081/episode/'
        + ${episode.id}" class="img-thumbnail">
    </p>
</div>
<br>
<ul class="list-group">
    <li class="list-group-item active">Comments</li>
    <li th:each="comment:${comments}" class="list-group-item">
        <a th:text="${comment.user.name}" th:href="'/user/' + ${comment.user.id}"></a>
        <span th:text="': ' + ${comment.comment}"></span>
    </li>
</ul>
<br>
<form th:action="'/comment/add/episode?userId=' + ${currentUser.id} + '&episodeId=' + ${episode.id}" method="post">
    <textarea th:placeholder="'Comment as ' + ${currentUser.name}" name="comment" class="form-control"
              required></textarea>
    <br>
    <button class="btn btn-primary" type="submit">Save Comment</button>
</form>
<br>
<div class="card" th:if="${currentUser.isAdmin()}">
    <div class="card-header">Episode Settings</div>
    <div class="card-body">
        <div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i>
            Change Video Path
        </div>
        <form th:action="'/episode/' + ${episode.id} + '/path'" method="post">
            <input th:value="${episode.path}" type="text" class="form-control" name="path">
            <br>
            <button type="submit" class="btn btn-primary">Save</button>
        </form>
    </div>
</div>
<br>
<a class="btn btn-primary" th:href="'/season/' + ${episode.season.id}">Back</a>
<script type="application/javascript">
    setInterval(function () {
        if (player.currentTime !== 0) {
            saveTime();
        }
    }, 5000);

    function saveTime() {
        $.ajax({
            type: "POST",
            url: "/time/episode",
            data: {
                userId: [[${currentUser.id}]],
                episodeId: [[${episode.id}]],
                time: player.currentTime
            }
        });
    }
</script>