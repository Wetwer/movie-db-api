<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">

<th:block th:switch="${currentUser.videoPlayer}">
    <script th:case="'html5'" type="application/javascript">
        $(window).bind("load", function () {
            document.getElementById('html-player').currentTime = [[${time}]]
        });
    </script>

    <th:block th:case="*">
        <link rel='stylesheet' href='https://cdn.plyr.io/3.4.7/plyr.css'>
        <script src='https://cdn.plyr.io/3.4.7/plyr.js'></script>
        <link rel="stylesheet" th:href="'../plyr/style.css'">
        <script th:src="'../plyr/index.js'"></script>
        <script type="application/javascript">
            $(window).bind("load", function () {
                player.currentTime = [[${time}]]
            });
        </script>
    </th:block>
</th:block>

<div th:if="${currentUser} != null" th:switch="${currentUser.videoPlayer}" id="movie-div">
    <video th:case="'html5'" controls playsinline th:poster="${movie.backgroundImg}" width="100%" id="html-player">
        <source th:src="'/video/movie/' + ${movie.id}" th:type="${movie.filetype}">
        <track th:each="subtitle : ${movie.subtitles}" th:src="'/subtitle/' + ${subtitle.id}" kind="subtitles"
               th:srclang="${subtitle.language}" th:label="${subtitle.language}">
    </video>
    <video th:case="*" controls playsinline th:poster="${movie.backgroundImg}" id="player">
        <source th:src="'/video/movie/' + ${movie.id}" th:type="${movie.filetype}">
        <track th:each="subtitle : ${movie.subtitles}" th:src="'/subtitle/' + ${subtitle.id}" kind="subtitles"
               th:srclang="${subtitle.language}" th:label="${subtitle.language}">
    </video>
</div>

<div class="card card-body">
    <h1 th:text="${movie.title} + ' (' + ${movie.year} + ')'"></h1>
    <form th:action="'/movie/' + ${movie.id} + '/like'" method="post" class="float-right">
        <button th:if="${hasliked} == true" type="submit" class="btn btn-danger">
            <i class="fas fa-heart"></i>
            <a th:text="' ' + ${movie.likes.size()} + ' likes'"></a>
        </button>
        <button th:if="${hasliked} == false" type="submit" class="btn btn-secondary">
            <i class="fas fa-heart"></i>
            <a th:text="' ' + ${movie.likes.size()} + ' likes'"></a>
        </button>
    </form>
    <br>
    <p>
        <a th:href="'/video/movie/' + ${movie.id}" target="_blank" class="btn btn-primary">Download</a>
    </p>
    <p th:text="'Rating: ' + ${movie.voteAverage}"></p>
    <p th:text="'Quality: ' + ${movie.quality}"></p>
    <p>Genres:
        <span th:each="genre : ${movie.genres}">
            <a th:text="${genre.name}" th:href="'/movies/1?genre=' + ${genre.name}" class="badge"
               style="color: white;"></a>
        </span>
    </p>
    <p th:text="${movie.descript}"></p>
    <p th:text="'Runtime: ' + ${movie.runtime} + ' Min'"></p>
    <p>
        <img th:src="'http://www.barcodes4.me/barcode/qr/qr.png?value=http://scorewinner.ch:8081/movie/' + ${movie.id}"
             class="img-thumbnail">
    </p>
</div>

<br>
<div class="card">
    <a class="card-body" data-toggle="collapse" href="#trailerCollapse" role="button" aria-expanded="false"
       aria-controls="trailerCollapse">
        <i class="fas fa-chevron-down"></i> Trailer
    </a>
    <div class="card-body collapse multi-collapse" id="trailerCollapse">
        <div class="plyr__video-embed" id="trailer">
            <iframe th:src="'https://www.youtube.com/embed/' + ${movie.trailerKey}
                        + '?origin=https://plyr.io&amp;iv_load_policy=3&amp;modestbranding=1&amp;playsinline=1&amp;showinfo=0&amp;rel=0&amp;enablejsapi=1'"
                    frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
</div>

<br>
<ul class="list-group">
    <li class="list-group-item active">Comments</li>
    <li th:each="comment:${movie.comments}" class="list-group-item">
        <a th:text="${comment.user.name}" th:href="'/user/' + ${comment.user.id}"></a>
        <span th:text="': ' + ${comment.comment}"></span>
    </li>
</ul>

<br>
<div th:if="${currentUser} != null">
    <form th:action="'/comment/add/movie?userId=' + ${currentUser.id} + '&movieId=' + ${movie.id}" method="post">
        <textarea name="comment" class="form-control" th:placeholder="'Comment as ' + ${currentUser.name}"
                  required></textarea>
        <br>
        <button class="btn btn-primary" type="submit">Save Comment</button>
    </form>
</div>
<br>
<div class="card" th:if="${currentUser.isAdmin()}">
    <a class="card-body" data-toggle="collapse" href="#settingsCollapse" role="button" aria-expanded="false"
       aria-controls="settingsCollapse">
        <i class="fas fa-chevron-down"></i> Movie Settings
    </a>
    <div class="card-body collapse multi-collapse" id="settingsCollapse">
        <h3>Change Video Path</h3>
        <form th:action="'/movie/' + ${movie.id} + '/path'" method="post">
            <input th:value="${movie.videoPath}" type="text" class="form-control" name="path">
            <br>
            <button type="submit" class="btn btn-primary">Save</button>
        </form>
        <hr>
        <h3>Change Movie Attributes</h3>
        <form th:action="'/movie/' + ${movie.id} + '/attributes'" method="post">
            Quality
            <input th:value="${movie.quality}" type="text" class="form-control" name="quality">
            Year
            <input th:value="${movie.year}" type="text" class="form-control" name="year">
            TMDB Id
            <input th:value="${movie.tmdbId}" type="number" class="form-control" name="tmdbId">
            <br>
            <button type="submit" class="btn btn-primary">Save</button>
        </form>
        <br>
        <a href="/subtitle/add">Add Subtitles</a>
    </div>
</div>
<br>
<div th:if="${!similar.isEmpty()}">
    <br>
    <div class="card">
        <div class="card-header">Similar Movies</div>
        <div class="row card-body">
            <div th:each="movie : ${similar}" class="col-12 col-md-4 col-lg-3" style="margin-bottom: 20px">
                <div th:include="'static/movieCard.html'"></div>
            </div>
        </div>
    </div>
</div>
<br>
<a href="/movies/1" class="btn btn-primary">Back</a>
<style>
    details summary::-webkit-details-marker {
        display: none;
        outline: none;
    }
</style>

<th:block th:switch="${currentUser.videoPlayer}">
    <script th:case="'html5'" type="application/javascript">
        setInterval(function () {
            if (document.getElementById('html-player').currentTime !== 0) {
                saveTime();
            }
        }, 5000);

        function saveTime() {
            $.ajax({
                type: "POST",
                url: "/time/movie",
                data: {
                    userId: [[${currentUser.id}]],
                    movieId: [[${movie.id}]],
                    time: document.getElementById('html-player').currentTime
                }
            });
        }
    </script>
    <script th:case="*" type="application/javascript">
        setInterval(function () {
            if (player.currentTime !== 0) {
                saveTime();
            }
        }, 5000);

        function saveTime() {
            $.ajax({
                type: "POST",
                url: "/time/movie",
                data: {
                    userId: [[${currentUser.id}]],
                    movieId: [[${movie.id}]],
                    time: player.currentTime
                }
            });
        }
    </script>
</th:block>
